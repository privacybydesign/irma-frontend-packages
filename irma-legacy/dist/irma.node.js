!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["irma-legacy"]=t():e["irma-legacy"]=t()}(global,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){r(1);const n=r(2),s=r(3),o=r(4),i=r(5),u=r(6),a=r(7),l=r(8),c=r(9),p="undefined"!=typeof window,f="INITIALIZED",d="CONNECTED",m="CANCELLED",y="DONE",b="TIMEOUT",g="ERROR",h="en",v={};function q(e,t,r,n){let s;e.type||e["@context"]?s={request:e}:e.request&&(s=e);const o={disclosing:"verification_request",issuing:"issue_request",signing:"signature_request"},i={"https://irma.app/ld/request/disclosure/v2":"verification_request","https://irma.app/ld/request/signature/v2":"signature_request","https://irma.app/ld/request/issuance/v2":"issue_request"};if(!o[s.request.type]&&!i[s.request["@context"]])throw new Error("Not an IRMA session request");if("publickey"!==t&&"hmac"!==t)throw new Error("Unsupported signing method");const u={algorithm:"publickey"===t?"RS256":"HS256",issuer:n,subject:o[s.request.type]||i[s.request["@context"]]};return c.sign({[{verification_request:"sprequest",issue_request:"iprequest",signature_request:"absrequest"}[u.subject]]:s},r,u)}function w(e,t,r){const n=new i(e,{serverSentEvents:{url:e=>`${e.url}/statusevents`,timeout:2e3},polling:{url:e=>`${e.url}/status`,interval:500,startState:t}});return new Promise((e,t)=>{n.observe(t=>{if(r.includes(t))return e(t)},t)}).finally(()=>n.close())}e.exports={ServerSession:o,handleSession:function(e,t={}){return new Promise((r,o)=>{const i=v[e];if("url"===t.method)return r(l.toDataURL(JSON.stringify(e)));let c={session:{handle:e,disableRestart:void 0===i},debugging:!1,detailedErrors:!0,language:t.language||h};if(i&&(c.session.start={...i.start,url:i.start.url.bind(null,i)}),t.server){const e=t.legacyResultJwt?"getproof":"result-jwt",r=t.resultJwt||t.legacyResultJwt?e:"result";c.session.result={url:()=>`${t.server}/session/${t.token}/${r}`,body:null,method:"GET",headers:{"Content-Type":"application/json"}}}const f=new n(c);switch(f.use(s),t.method){case"canvas":return o(new Error("Method canvas is not supported anymore, please switch to popup mode or use irma-js-packages."));case"console":f.use(u);break;case"mobile":console.info("irmajs: the method mobile has been fully integrated in the option popup");case"popup":case void 0:if(!p)return o(new Error("Method popup is only available in browser environments"));f.use(a);break;default:return o(new Error(`Specified method ${t.method} unknown`))}f.start().then(r).catch(e=>o(function(e){if("Aborted"!==e.newState)return e;switch(e.oldState){case"Error":return g;case"TimedOut":return b;default:return m}}(e)))})},startSession:function(e,t,r,n,s){let i,u={url:e};if("publickey"!==r&&"hmac"!==r||(i=q(t,r,n,s)),i||"string"==typeof t)u.start={url:e=>`${e.url}/session`,body:i||t,method:"POST",headers:{"Content-Type":"text/plain"}};else if(u.start={url:e=>`${e.url}/session`,body:JSON.stringify(t),method:"POST",headers:{"Content-Type":"application/json"}},"token"===r)u.start.headers.Authorization=n;else if(void 0!==r&&"none"!==r)throw new Error(`Method ${r} is not supported right now`);return new o({...u,start:{...u.start,qrFromResult:e=>e}}).start().then(e=>(v[e.sessionPtr]=u,e))},signSessionRequest:q,waitConnected:function(e){return w(e,f,[d,y])},waitDone:function(e){return w(e,f,[y])}}},function(e,t){},function(e,t){e.exports=require("irma-core")},function(e,t){e.exports=require("irma-server")},function(e,t){e.exports=require("irma-server/server-session")},function(e,t){e.exports=require("irma-server/server-state")},function(e,t){e.exports=require("irma-console")},function(e,t){},function(e,t){e.exports=require("qrcode")},function(e,t){e.exports=require("jsonwebtoken")}])}));